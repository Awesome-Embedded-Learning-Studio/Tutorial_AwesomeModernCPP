# std::string_view å…¨æ”»ç•¥

ç¬”è€…æœ€è¿‘å¸¸å¸¸è·Ÿå­—ç¬¦ä¸²æ‰“äº¤é“ï¼Œè¿™ç¯‡åšå®¢ä¹Ÿæ˜¯è·Ÿå…ˆå‰çš„C++å·¥ç¨‹å®è·µä¸€èµ·è”åŠ¨çš„â€”â€”ä¹Ÿå°±æ˜¯è§£å†³IniParserçš„é—®é¢˜

> ä¼ é€é—¨
>
> - CSDNï¼š[ç°ä»£C++å·¥ç¨‹å®è·µï¼šç®€å•çš„IniParser2ï¼šåˆ†è§£éœ€æ±‚ä¸ç¼–å†™split-CSDNåšå®¢](https://blog.csdn.net/charlie114514191/article/details/155731063)
> - çŸ¥ä¹ï¼š[ç°ä»£C++å·¥ç¨‹å®è·µï¼šç®€å•çš„IniParser2ï¼šåˆ†è§£éœ€æ±‚ä¸ç¼–å†™split - è€è€è€é™ˆé†‹çš„æ–‡ç«  - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/1981659758034437080)
> - Github: [Awesome-Embedded-Learning-Studio/Tutorial_cpp_SimpleIniParser: è¿™æ˜¯æˆ‘ä»¬C++å·¥ç¨‹åŒ–å¼€å§‹çš„æ—…ç¨‹ï¼æ‰‹æ“ä¸€ä¸ªæœ€ç®€å•çš„Iniåˆ†æå™¨ï¼This is the beginning of our journey in C++ engineering! Handcrafting the simplest INI parser!](https://github.com/Awesome-Embedded-Learning-Studio/Tutorial_cpp_SimpleIniParser)

## å…ˆåˆ«æ€¥ï¼Œå…ˆé—®æ˜¯ä»€ä¹ˆ

#### `std::string_view` æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦å®ƒï¼Ÿ

`std::string_view`ï¼ˆC++17ï¼‰æ˜¯ä¸€ä¸ªè½»é‡ã€ä¸å¯å˜çš„â€œå­—ç¬¦ä¸²è§†å›¾â€ç±»å‹ï¼š**å®ƒä¸æ‹¥æœ‰å­—ç¬¦ç¼“å†²åŒºï¼Œåªä¿å­˜æŒ‡å‘å­—ç¬¦åºåˆ—èµ·å§‹å¤„çš„æŒ‡é’ˆå’Œé•¿åº¦ï¼ˆsizeï¼‰**ï¼ˆPSï¼šæ‰€ä»¥ä½ çœ‹ï¼Œæ˜¯ä¸æ˜¯å¾ˆâ€œè§†å›¾â€ï¼‰ï¼Œç”¨äºä»¥ O(1) çš„ä»£ä»·è¡¨ç¤ºå­ä¸²ã€å­—é¢é‡æˆ–å…¶ä»–å­—ç¬¦åºåˆ—çš„åªè¯»çª—å£ã€‚å®ƒçš„è®¾è®¡æ˜¯ä¸ºäº†è§£å†³é¢‘ç¹è¯»æ“ä½œæ—¶ä¸å¿…è¦çš„å†…å­˜æ‹·è´é—®é¢˜ï¼Œä»è€Œæé«˜æ€§èƒ½ä¸é€šç”¨æ€§ã€‚

> Sir This way: [C++å‚è€ƒæ–‡çŒ®](https://en.cppreference.com/w/cpp/string/basic_string_view.html)



------

## std::string_view çš„å®ç°åŸç†

> PSï¼Œä¸æ„Ÿå…´è¶£å°±ç›´æ¥è·³ï¼Œä½†æ˜¯çŸ¥é“æ¯”ä¸çŸ¥é“å¥½ `:)`

è™½ç„¶æ ‡å‡†æ²¡æœ‰è§„å®šå…·ä½“çš„å†…éƒ¨ç»“æ„ï¼Œä½† **æ‰€æœ‰ä¸»æµå®ç°ï¼ˆlibstdc++ / libc++ / MSVC STLï¼‰éƒ½ä½¿ç”¨ä¸¤å­—æ®µæˆ–ä¸‰å­—æ®µçš„ç®€å•ç»“æ„**ï¼š

```cpp
template<class CharT, class Traits = std::char_traits<CharT>>
class basic_string_view {
    const CharT* _ptr;   // æŒ‡å‘åº•å±‚å­—ç¬¦åºåˆ—ï¼ˆä¸æ‹¥æœ‰ï¼‰
    size_t       _len;   // é•¿åº¦ï¼ˆä¸å« '\0'ï¼‰
};
```

#### ç‰¹ç‚¹ï¼š

1. **ä¸æ‹¥æœ‰å†…å­˜ï¼ˆnon-owning viewï¼‰**
2. åªä¿å­˜ä¸¤ä»½è½»é‡ä¿¡æ¯ï¼šæŒ‡é’ˆ + é•¿åº¦
3. å¤åˆ¶ä¾¿å®œï¼šä»…å¤åˆ¶ä¸¤ä¸ªå­—ï¼ˆ8 å­—èŠ‚æŒ‡é’ˆ + 8 å­—èŠ‚ sizeï¼‰
4. ä»»ä½•â€œå­ä¸²æ“ä½œâ€ï¼ˆsubstrã€remove_prefixï¼‰éƒ½åªæ”¹ `_ptr`/`_len`ï¼Œ**O(1) æ— åˆ†é…**

ç›¸æ¯”ä¹‹ä¸‹ï¼Œ`std::string` é™¤äº†æŒ‡é’ˆå¤–ï¼Œè¿˜ç®¡ç†å®¹é‡ã€åˆ†é…å™¨ã€éƒ¨åˆ†è¿˜åŒ…å«å°å­—ç¬¦ä¸²ä¼˜åŒ–ï¼ˆSSOï¼‰ï¼ŒåŒæ—¶æœ‰ææ„é€»è¾‘ï¼Œæˆæœ¬å®Œå…¨ä¸åŒã€‚æ‰€ä»¥è¿™æ ·çœ‹`std::string`æ˜¾ç„¶å¾ˆé‡ï¼Œå¯¹å§ã€‚

------

## string_view å†…éƒ¨å‡½æ•°å¦‚ä½•å¤„ç†æ•°æ®ï¼Ÿ

#### ä¾‹ï¼šsubstr

```cpp
string_view substr(size_t pos, size_t count) const {
    return string_view(_ptr + pos, min(count, _len - pos));
}
```

å®Œå…¨æ²¡æœ‰å¼€è¾Ÿæ–°å†…å­˜ï¼Œä»…è°ƒæ•´æŒ‡é’ˆå’Œé•¿åº¦ã€‚

#### remove_prefix

```cpp
void remove_prefix(size_t n) {
    _ptr += n;
    _len -= n;
}
```

#### compare / find ç­‰æ“ä½œ

å…¨éƒ¨æ˜¯å¯¹ `_ptr` æŒ‡å‘çš„å†…å­˜ç›´æ¥éå†ï¼ˆé€šå¸¸ä¾èµ– `Traits::compare`ï¼‰ï¼Œä¸æ¶‰åŠæ–°å†…å­˜åˆ›å»ºã€‚

------

#### ä¸€å¥è¯æ€»ç»“å…¶å®ç°å“²å­¦ï¼š

**`string_view` æ˜¯ä¸€ä¸ª lightweight faÃ§adeï¼ˆè½»é‡å¤–å£³ï¼‰ï¼ŒæŠŠä»»æ„å­—ç¬¦åºåˆ—å˜æˆ â€œå¯æ“ä½œçš„åªè¯»å­—ç¬¦ä¸²å¯¹è±¡â€ï¼Œä½†æ°¸è¿œä¸è´Ÿè´£å†…å­˜ã€‚**è¿™ç§æˆ‘ç›¸ä¿¡å¤§ä¼™å°±ä¼šæ‹‰é«˜è­¦æƒ•äº†ã€‚è‚¯å®šå¤„ç†ä¸å¥½å°±è¦è·Ÿç”Ÿå‘½å‘¨æœŸç‚¸äº†ã€‚æ‰€ä»¥ï¼šè¿™æ—¢æ˜¯ä¼˜åŠ¿ï¼Œä¹Ÿæ˜¯æœ€å¤§çš„é£é™©æ¥æºï¼ˆç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼‰ã€‚

------

## ä¸ const char* çš„æœ¬è´¨å¯¹æ¯”ï¼ˆé€é¡¹åˆ†æï¼‰

ç¬”è€…è®°å¾—ä¹‹å‰æœ‰åœ¨çŸ¥ä¹ä¸Šçœ‹åˆ°å¤§ä½¬ä»¬çš„è®¨è®ºï¼šè®¾è®¡ä¸Šï¼Œè·Ÿconst char*çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿå®é™…ä¸Šå›é¡¾è®¾è®¡ï¼Œç¬”è€…è®¤ä¸ºï¼Œå¦‚æœè¯´std::stringå°è£…äº†char[]ï¼Œé‚£ä¹ˆ`string_view`å°è£…äº†const char\*ã€‚

------

#### è¡¨è¾¾èƒ½åŠ›ï¼šstring_view æ˜¯â€œå¸¦é•¿åº¦çš„å­—ç¬¦ä¸²â€ï¼Œchar* æ˜¯â€œæŒ‡é’ˆâ€

æ„Ÿè°¢GPTï¼Œæˆ‘å†™äº†ä¸€ä¼šï¼Œè®©ä»–æ‹‰äº†ä¸€ä¸ªè¡¨æ ¼ï¼Œå¯ä»¥çœ‹çœ‹ï¼š

| ç‰¹æ€§                                   | `std::string_view`       | `const char*`                            |
| -------------------------------------- | ------------------------ | ---------------------------------------- |
| æ˜¯å¦åŒ…å«é•¿åº¦                           | âœ” æœ‰ `size()`            | âŒ æ²¡æœ‰ï¼Œéœ€è¦ `strlen`                    |
| è¡¨ç¤ºå­ä¸²æ˜¯å¦å®‰å…¨                       | âœ” å®Œæ•´æ”¯æŒï¼ˆæœ‰é•¿åº¦ï¼‰     | âŒ åªèƒ½é€šè¿‡ä¸´æ—¶ä¿®æ”¹ `'\0'` æˆ–ä¼ é€’é¢å¤–é•¿åº¦ |
| æ˜¯å¦å¯ä»¥ä¸ºä»»æ„å­—èŠ‚åºåˆ—æœåŠ¡ï¼ˆå«é›¶å­—ç¬¦ï¼‰ | âœ” å¯ä»¥ï¼ˆé•¿åº¦ç‹¬ç«‹ï¼‰       | âŒ éœ€è¦ NUL ç»ˆæ­¢                          |
| æ˜¯å¦æ”¯æŒéå†ã€æŸ¥æ‰¾ã€æ¯”è¾ƒç­‰é«˜çº§æ¥å£     | âœ” ä¸°å¯Œçš„æˆå‘˜å‡½æ•°         | âŒ å‡ ä¹æ²¡æœ‰ï¼Œç”¨ C å‡½æ•°                    |
| å­—é¢é‡è½¬æ¢æ˜¯å¦ç®€æ´                     | âœ” `"abc"sv`ï¼ˆC++17 UDLï¼‰ | âœ” å¯ç›´æ¥ä½¿ç”¨ `"abc"`                     |

æ ¸å¿ƒåŒºåˆ«æ˜¯ï¼š

- ã€string_view = (æŒ‡é’ˆ, é•¿åº¦)ã€‘
- ã€const char* = æŒ‡é’ˆ + éšå«ä»¥ '\0' ç»ˆæ­¢ã€‘

æ‰€ä»¥`string_view` çš„ **æ˜¾å¼é•¿åº¦** æ˜¯ä¸€ä¸ªå·¨å¤§çš„ä¼˜åŠ¿ã€‚å› ä¸ºæœ‰çš„æ—¶å€™è¿™ç§`\0`ä¸æ˜¯æˆ‘ä»¬çš„æ„å›¾ã€‚

------

#### 2ï¼‰å®‰å…¨æ€§ï¼šstring_view å¯¹æ¯” const char*

##### string_view åœ¨è®¿é—®è¶Šç•Œæ–¹é¢æ›´å®‰å…¨

```cpp
sv[i]  // æœ‰è¾¹ç•Œæ£€æŸ¥ï¼ˆdebugï¼‰ï¼Œrelease é€šå¸¸ä¸æ£€æŸ¥ä½†åŸºäº _len è®¡ç®—
```

è€Œï¼š

```cpp
p[i]   // å®Œå…¨æ²¡æœ‰ä»»ä½•è¾¹ç•Œæ¦‚å¿µ
```

#### string_view åœ¨ç”Ÿå‘½å‘¨æœŸæ–¹é¢æ›´å±é™©ï¼ˆå®¹æ˜“æ‚¬ç©ºï¼‰

`string_view` ä¸æ‹¥æœ‰å†…å­˜ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“è¿™æ ·å†™å‡º bugï¼š

```cpp
std::string_view sv = std::string("abc"); // æŒ‡å‘ä¸´æ—¶ -> æ‚¬ç©º
```

ä½† `const char*` åŒæ ·ä¼šæ‚¬ç©ºï¼Œä¾‹å¦‚ï¼š

```cpp
const char* p = std::string("abc").c_str(); // åŒæ ·æ‚¬ç©º
```

**ä¸¤è€…éƒ½ä¼šæ‚¬ç©ºï¼ŒåŒºåˆ«åªæ˜¯ `string_view` æ›´å–œæ¬¢è¢«éšå¼æ„é€ ï¼Œæ‰€ä»¥æ›´å®¹æ˜“çŠ¯é”™**ã€‚

------

#### 3ï¼‰æ€§èƒ½å·®å¼‚

| æ“ä½œ                  | string_view             | const char*                 |
| --------------------- | ----------------------- | --------------------------- |
| å¤åˆ¶                  | O(1) ä¸¤ä¸ªå­—             | O(1) ä¸€ä¸ªå­—                 |
| æ¯”è¾ƒ                  | é•¿åº¦å¯ç”¨ï¼Œæ€§èƒ½æ›´å¥½      | å¿…é¡»æ‰«æå¹¶æ¯”å¯¹ç›´åˆ° `'\0'`   |
| å­ä¸²æ“ä½œ              | O(1)                    | å¿…é¡»æ‰‹å·¥æ„é€ æ–°çš„æŒ‡é’ˆ/ç»ˆæ­¢ç¬¦ |
| ä¸ std::string äº’æ“ä½œ | ğŸš€ ç›´æ¥æ„é€  viewï¼Œæ— æ‹·è´ | âŒ å¸¸éœ€ strlenï¼Œå¯èƒ½ O(n)    |

å…¸å‹æ€§èƒ½å·®ï¼š

##### æ‰«æé•¿åº¦

```cpp
strlen(const char*)  // O(n)
sv.size()            // O(1)
```

æ‰€ä»¥å¦‚æœä½ çš„å‡½æ•°è¿™æ ·å†™ï¼š

```cpp
void foo(const char* p);
```

ç„¶åå†…éƒ¨å¤šæ¬¡ `strlen(p)`ï¼Œä¼šå˜æˆ O(nÂ²) æ¨¡å¼ã€‚

æ”¹æˆï¼š

```cpp
void foo(std::string_view sv);
```

å°±æ²¡æœ‰è¿™ç§æ€§èƒ½å‘ã€‚

------

## ç”¨æ³•å±‚é¢çš„å·¨å¤§å·®å¼‚

#### string_view æ˜¯ â€œåªè¯»å­—ç¬¦ä¸²â€çš„è¯­ä¹‰ç±»å‹

å®ƒæ˜ç¡®å‘Šè¯‰è¯»è€…ï¼š

- **æˆ‘ä¸ä¿®æ”¹**
- **æˆ‘ä¸å¤åˆ¶**
- **æˆ‘ä¸æ‹¥æœ‰æ•°æ®**

è€Œ const char* æ— æ³•è¡¨è¾¾æ‰€æœ‰è¿™äº›è¯­ä¹‰ï¼š

```cpp
const char* p;
```

ä½ æ ¹æœ¬ä¸çŸ¥é“ï¼š

- p æ˜¯ä¸æ˜¯åªè¯»ï¼ˆä¹Ÿè®¸æ¥è‡ª char æ•°ç»„ï¼‰
- p æ˜¯å¦æŒ‡å‘ NUL ç»ˆæ­¢çš„ç©ºé—´
- p æ˜¯å¦æœ‰å›ºå®šé•¿åº¦
- p æ˜¯å¦èƒ½åŒ…å« '\0'
- p æ˜¯å¦æœ‰æ•ˆ

string_view è§£å†³äº†è¿™äº›è¯­ä¹‰ä¸Šçš„æ­§ä¹‰ã€‚

------

## å¸¸ç”¨æˆå‘˜ / æ“ä½œé€ŸæŸ¥ï¼ˆé€‰å–å…³é”® APIï¼‰

- `size(), length(), empty()`ï¼šé•¿åº¦/ç©ºåˆ¤æ–­ï¼ˆå¦‚ `basic_string`ï¼‰ã€‚
- `data()`ï¼šè¿”å›æŒ‡å‘å½“å‰è§†å›¾èµ·å§‹å­—ç¬¦çš„æŒ‡é’ˆ â€”â€” **æ³¨æ„ï¼šä¸ä¿è¯ä»¥ `'\0'` ç»“å°¾**ï¼ˆå¦‚æœä½ ä»å®Œæ•´ C å­—ç¬¦ä¸²æ„é€ ä¸”æœªåšå­è§†å›¾æ“ä½œï¼Œå¯èƒ½æ˜¯ä»¥ `'\0'` ç»ˆæ­¢ï¼Œä½†ä¸èƒ½ä¾èµ–ï¼‰ã€‚å› æ­¤ç”¨ `data()` ä¼ ç»™è¦æ±‚ NUL ç»“å°¾çš„ C API å¸¸å¸¸æ˜¯é”™è¯¯çš„ã€‚
- `substr(pos, count)`ï¼šè¿”å›ä¸€ä¸ªæ–°çš„ `string_view`ï¼ˆO(1)ï¼‰è¡¨ç¤ºå­åŒºé—´ï¼Œä¸åˆ†é…å†…å­˜ã€‚
- `remove_prefix(n)`, `remove_suffix(n)`ï¼šä¿®æ”¹è§†å›¾ï¼ˆç§»åŠ¨èµ·ç‚¹æˆ–ç¼©çŸ­é•¿åº¦ï¼‰ï¼Œä¹Ÿéƒ½æ˜¯ O(1)ã€‚
- æ¯”è¾ƒå‡½æ•° `compare()` ä¸é‡è½½äº† `==, <, >` ç­‰æ“ä½œç¬¦ï¼ˆæŒ‰å­—å…¸åº / é•¿åº¦ç­‰æ¯”è¾ƒè§„åˆ™ï¼‰ï¼Œ`operator<<` æ”¯æŒæµè¾“å‡ºã€‚

------

## å­—é¢é‡ä¸ä¾¿æ·å†™æ³•

C++17 æä¾›äº† UDLï¼ˆuser-defined-literalï¼‰`""sv`ï¼Œå¯ä»¥ç›´æ¥å†™ `"hello"sv` å¾—åˆ°ä¸€ä¸ª `std::string_view`ï¼ˆè¯¥å­—é¢é‡åœ¨ `std::literals::string_view_literals` å‘½åç©ºé—´ä¸­ï¼‰ã€‚è¿™æ˜¯æ„é€ å¯¹å­—é¢é‡çš„å¸¸ç”¨å¿«æ·æ–¹å¼ã€‚

------

## æ€§èƒ½è¯­ä¹‰ä¸æ¥å£è®¾è®¡å»ºè®®

- **ä¼ å‚ï¼šæŒ‰å€¼è¿˜æ˜¯æŒ‰ `const&`ï¼Ÿ** é€šå¸¸å»ºè®®æŠŠ `std::string_view` å½“æˆå°çš„å€¼ç±»å‹æ¥ä¼ é€’ï¼ˆå³æŒ‰å€¼ï¼‰ã€‚ç†ç”±åŒ…æ‹¬ï¼šä¼ å€¼æ¶ˆé™¤ä¸€æ¬¡é—´æ¥ï¼Œä»£ç æ›´å¯è¯»ï¼ˆä¹Ÿè§ ISO C++ ç¤¾åŒºä¸ Abseil çš„å»ºè®®ï¼‰ï¼Œä¸è¿‡åœ¨æŸäº› ABI/å¹³å°ï¼ˆå†å²ä¸Š MSVC x86-64 ç­‰ï¼‰ä¸‹ï¼ŒæŒ‰å€¼å¹¶ä¸æ€»æ˜¯æ›´å¿«ï¼Œä½†æ•´ä½“å®è·µå»ºè®®â€œä¹ æƒ¯æ€§æŒ‰å€¼ä¼ é€’â€ã€‚
- **ç”¨ä½œå®¹å™¨é”®ï¼ˆ`unordered_map`/`unordered_set`ï¼‰ï¼Ÿ** æ ‡å‡†åº“ä¸º `string_view` æä¾›äº† `std::hash` çš„ç‰¹åŒ–ï¼Œå¯ä»¥ç›´æ¥ä½œä¸ºé”®ï¼Œä¸è¿‡å…³é”®åœ¨äºï¼š**ä½¿ç”¨ `string_view` ä½œä¸ºé”®æ—¶å¿…é¡»ä¿è¯è¢«è§†å›¾æŒ‡å‘çš„æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸè‡³å°‘ä¸å“ˆå¸Œè¡¨ä¸­è¯¥é”®çš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·é•¿**ï¼Œå¦åˆ™ä¼šå‘ç”Ÿæ‚¬ç©ºå¼•ç”¨ã€‚`std::hash<string_view>` ä¸ `std::hash<string>` çš„è¡Œä¸ºåœ¨ cppreference æœ‰è¯´æ˜ï¼ˆhash ç›¸ç­‰æ€§çš„æè¿°ï¼‰ã€‚

------

## è¿˜è¦å†å¼ºè°ƒä¸€ä¸‹ç”Ÿå‘½å‘¨æœŸä¸æ‚¬ç©ºï¼ˆçœŸæ­£çš„â€œå‘â€ï¼‰

**æ ¸å¿ƒè­¦ç¤ºï¼š`std::string_view` ä¸æ‹¥æœ‰åº•å±‚æ•°æ®ã€‚å®ƒä¸ä¼šå»¶é•¿åº•å±‚å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚**
 å…¸å‹é”™è¯¯åœºæ™¯ï¼š

```cpp
std::string_view f() {
    std::string s = "hello";
    return std::string_view{s}; // è¿”å›å string s è¢«é”€æ¯ï¼Œè§†å›¾æ‚¬ç©º â€”â€” æœªå®šä¹‰è¡Œä¸º
}
```

æˆ–ï¼š

```cpp
auto sv = std::string_view{ some_function_returning_temp_string() }; // temp è¢«ææ„ï¼Œsv æ‚¬ç©º
```

è¿™ç±»â€œuse-after-free / dangling viewâ€æ˜¯ `string_view` æœ€å¸¸è§ä¸æœ€ä¸¥é‡çš„ bug æ ¹æºã€‚é™æ€åˆ†æå™¨å’Œä»£ç å®¡æŸ¥è¦é‡ç‚¹å…³æ³¨è¿™ç±»æ¨¡å¼ã€‚å­¦æœ¯/å·¥ç¨‹ç¤¾åŒºä¹Ÿæœ‰ç ”ç©¶å·¥å…·æ£€æµ‹è¿™ç±»é—®é¢˜ã€‚

**å¦‚ä½•é˜²å¾¡ï¼š**

1. åœ¨ API å±‚çº§æ˜ç¡®è¯­ä¹‰ï¼šè‹¥å‡½æ•°éœ€è¦æŒæœ‰å­—ç¬¦ä¸²å‰¯æœ¬ï¼Œå‚æ•°å°±ç”¨ `std::string`ï¼ˆæˆ–åœ¨å†…éƒ¨åš `std::string` çš„æ‹·è´ï¼‰ï¼›è‹¥åªåœ¨è°ƒç”¨æœŸå†…ä½¿ç”¨ï¼Œåˆ™ `string_view` å¾ˆåˆé€‚ã€‚
2. ä¸æŠŠ `string_view` å­˜å…¥éœ€è¦é•¿æœŸæŒæœ‰çš„å®¹å™¨ï¼Œé™¤éä½ èƒ½ä¿è¯åº•å±‚ç¼“å†²åŒºçš„æ‰€æœ‰æƒï¼ˆä¾‹å¦‚é™æ€å¸¸é‡å­—é¢é‡æˆ–ä¸€ç›´å­˜æ´»çš„æ± ï¼‰ã€‚
3. åœ¨ä» `std::string` è·å– `string_view` å¹¶ä¼ é€’ç»™å¼‚æ­¥/å»¶è¿Ÿæ‰§è¡Œçš„ä»£ç æ—¶å°¤å…¶å°å¿ƒï¼ˆä¾‹å¦‚çº¿ç¨‹ã€å¼‚æ­¥ä»»åŠ¡ã€lambda æ•è·åå»¶è¿Ÿæ‰§è¡Œï¼‰ã€‚
4. ä½¿ç”¨é™æ€åˆ†æå·¥å…·æˆ–ç¼–è¯‘å™¨è­¦å‘Šï¼ˆå¹¶ä¿æŒ Code Review å…³æ³¨ï¼‰æ¥æ•æ‰å…¸å‹ç”¨æ³•é”™è¯¯ã€‚

------

## `data()` ä¸ NUL ç»ˆæ­¢é—®é¢˜ï¼ˆå®è·µè­¦å‘Šï¼‰

`string_view::data()` è¿”å›çš„ç¼“å†²å¹¶**ä¸ä¿è¯**ä»¥ NUL (`'\0'`) ç»“å°¾ï¼ˆä¾‹å¦‚å¯¹ä¸€ä¸ªé€šè¿‡ `remove_suffix` æˆ– `substr` ç”Ÿæˆçš„è§†å›¾ï¼‰ï¼Œå› æ­¤æŠŠ `sv.data()` ç›´æ¥ä¼ ç»™åªæ¥å— C é£æ ¼ NUL ç»ˆæ­¢å­—ç¬¦ä¸²çš„ APIï¼ˆå¦‚ `printf("%s")`ã€ä¸€äº›è€ C åº“å‡½æ•°ï¼‰æ˜¯å®¹æ˜“å‡ºé”™çš„ã€‚è‹¥ç¡®å®éœ€è¦ NUL ç»ˆæ­¢ï¼Œå¿…é¡»æ˜¾å¼æ‹·è´åˆ° `std::string` å¹¶åœ¨æœ«å°¾åŠ  `'\0'`ï¼ˆæˆ–åœ¨ C++20 å¯ç”¨ `std::string svstr(sv);`ï¼‰ã€‚

------

## å¸¸è§è¯¯ç”¨æ ·ä¾‹ä¸æ­£ç¡®å†™æ³•ï¼ˆä»£ç ç¤ºä¾‹ï¼‰

ç¬”è€…ä¹‹å‰ä¸å¤ªä¼šç”¨`std::string_view`ï¼Œå°±å¹²å‡ºæ¥è¿‡è¿™ç§äº‹æƒ…ï¼š

#### é”™è¯¯ï¼šè¿”å›æŒ‡å‘ä¸´æ—¶çš„ string_viewï¼ˆæ‚¬ç©ºï¼‰

```cpp
std::string_view make_view_bad() {
    return std::string("temp"); // UBï¼šè¿”å›çš„ view æŒ‡å‘ä¸´æ—¶ string çš„ç¼“å†²åŒº
}
```

#### æ­£ç¡®ï¼šå¦‚æœéœ€è¦é•¿æœŸä¿å­˜ï¼Œæ‹·è´åˆ° std::string

```cpp
std::string make_copy() {
    return std::string("temp");
}
auto v = make_copy();            // v æ˜¯ std::stringï¼Œæ‹¥æœ‰æ•°æ®
std::string_view sv = v;        // sv å¯å®‰å…¨ä½¿ç”¨ï¼Œå‰ææ˜¯ v ä¸é”€æ¯
```

#### å¥½çš„ API ä¹ æƒ¯ï¼ˆæ¥å—ä»»æ„åªè¯»å­—ç¬¦ä¸²ï¼‰

```cpp
#include <string_view>

void process(std::string_view sv) {
    // åªåœ¨è°ƒç”¨æœŸé—´ä½¿ç”¨ sv
    if (sv.size() > 10) { /*...*/ }
}

int main() {
    std::string s = "hello";
    process(s);            // implicit conversion
    process("literal");    // ok, string literal çš„ storage æ˜¯é™æ€çš„ï¼Œä¼šè¢«æ”¾ç½®åˆ°dataæ®µæ‰€ä»¥æ— æ‰€è°“
}
```

é€šå¸¸æ¨èæŠŠ `std::string_view` ä½œä¸ºâ€œåªè¯»è¾“å…¥å‚æ•°â€çš„é¦–é€‰ç±»å‹ï¼ˆæŒ‰å€¼ï¼‰ã€‚

------

## ä¸ std::string / char* çš„è½¬æ¢ä¸äº’æ“ä½œ

- `string_view` å¯éšå¼ä» `std::string` æˆ– `const char*` æ„é€ ï¼ˆæ³¨æ„æ‚¬ç©ºé£é™©ï¼‰ã€‚
- `std::string` å¯ä»¥ä» `string_view` æ„é€ ï¼ˆä¼šè¿›è¡Œæ‹·è´ï¼‰ã€‚è‹¥éœ€ C é£æ ¼ NUL ç»“å°¾çš„ç¼“å†²åŒºï¼Œæ„é€ åå¯ç”¨ `c_str()` æˆ– `data()`ï¼ˆC++11 å `data()` è¿”å› NUL ç»ˆæ­¢çš„ char* åœ¨éƒ¨åˆ†ç‰ˆæœ¬çš„æ ‡å‡†é‡Œæœ‰ç»†å¾®å·®åˆ«ï¼Œä½†ä» C++17 `std::string::data()` ä¿è¯å¯ç”¨äº read-only NUL-terminated C stringï¼‰ã€‚å¯¹äº `string_view::data()`ï¼Œ**ä»ä¸ä¿è¯æœ«å°¾ NUL**ã€‚

# Reference

ä¸‹é¢æ˜¯æœ¬æ–‡ä¸­ç”¨åˆ°çš„é‡è¦å‚è€ƒèµ„æ–™ï¼ˆç‚¹å‡»å³å¯é˜…è¯»æƒå¨æè¿°ï¼‰ï¼š

- cppreference â€” `std::basic_string_view`ï¼ˆæ€»è§ˆã€æˆå‘˜ã€æ³¨æ„äº‹é¡¹ï¼‰ã€‚([C++å‚è€ƒæ–‡çŒ®](https://en.cppreference.com/w/cpp/string/basic_string_view.html?utm_source=chatgpt.com))
- cppreference â€” `basic_string_view` æ„é€ å‡½æ•°ç»†èŠ‚é¡µé¢ã€‚([C++å‚è€ƒæ–‡çŒ®](https://en.cppreference.com/w/cpp/string/basic_string_view/basic_string_view.html?utm_source=chatgpt.com))
- cppreference â€” `data()` çš„è¯´æ˜ï¼ˆ**ä¸ä¿è¯ NUL**ï¼‰ã€‚([C++å‚è€ƒæ–‡çŒ®](https://en.cppreference.com/w/cpp/string/basic_string_view/data.html?utm_source=chatgpt.com))
- cppreference â€” ç”¨æˆ·å­—é¢é‡ `operator""sv`ï¼ˆ`"..."sv`ï¼‰ã€‚([C++å‚è€ƒæ–‡çŒ®](https://en.cppreference.com/w/cpp/string/basic_string_view/operator%22%22sv.html?utm_source=chatgpt.com))
- cppreference â€” `std::hash` å¯¹ `string_view` çš„ç‰¹åŒ–è¯´æ˜ã€‚([C++å‚è€ƒæ–‡çŒ®](https://en.cppreference.com/w/cpp/string/basic_string_view/hash.html?utm_source=chatgpt.com))
- cppreference â€” æ¯”è¾ƒ/è¿ç®—ç¬¦æ–‡æ¡£ï¼ˆcompare / operator== ç­‰ï¼‰ã€‚([C++å‚è€ƒæ–‡çŒ®](https://en.cppreference.com/w/cpp/string/basic_string_view/operator_cmp.html?utm_source=chatgpt.com))
- cppreference â€” `operator<<`ï¼ˆæµè¾“å‡ºæ”¯æŒï¼‰ã€‚([C++å‚è€ƒæ–‡çŒ®](https://en.cppreference.com/w/cpp/string/basic_string_view/operator_ltlt.html?utm_source=chatgpt.com))
- å­¦æœ¯/å·¥ç¨‹ï¼šå…³äº `string_view` ç”Ÿå‘½å‘¨æœŸé”™è¯¯æ£€æµ‹çš„ç ”ç©¶ï¼ˆç¤ºä¾‹è®ºæ–‡ï¼‰ã€‚([arXiv](https://arxiv.org/abs/2408.09325?utm_source=chatgpt.com))
- è®¨è®º/ç¤ºä¾‹ï¼šStackOverflow ä¸Šå…³äº `string_view` æ‚¬ç©ºä¸å®é™…ç¤ºä¾‹çš„è®¨è®ºï¼ˆå…¥é—¨çº§é”™è¯¯ç¤ºä¾‹ï¼‰ã€‚([Stack Overflow](https://stackoverflow.com/questions/55790420/is-string-view-really-promoting-use-after-free-errors?utm_source=chatgpt.com))
- ISO WG21 ææ¡ˆ / æœªæ¥å·¥ä½œï¼š`zstring_view` ææ¡ˆï¼ˆç¤ºä¾‹ï¼‰ã€‚([å¼€æ”¾æ ‡å‡†](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2025/p3655r0.html?utm_source=chatgpt.com))

------

### ç»“æŸè¯­

`std::string_view` æ˜¯ C++17 å¸¦æ¥çš„éå¸¸å®ç”¨ä¸”é«˜æ•ˆçš„å·¥å…·ï¼šåœ¨é€‚åˆçš„åœ°æ–¹å®ƒèƒ½æ˜¾è‘—å‡å°‘å¤åˆ¶ï¼Œæé«˜è§£æ/å¤„ç†å­—ç¬¦ä¸²çš„æ€§èƒ½ã€‚ä½†åŒæ—¶ï¼Œå®ƒä¹ŸæŠŠâ€œè°è´Ÿè´£æ•°æ®æ‰€æœ‰æƒâ€è¿™ä¸ªé—®é¢˜æ˜¾å¼åœ°äº¤è¿˜ç»™äº†ç¨‹åºå‘˜ã€‚æŠŠ `string_view` å½“ä½œâ€œè½»é‡çš„åªè¯»çª—å£â€æ¥ç”¨ï¼Œå¹¶åœ¨æ¥å£è®¾è®¡ä¸ç”Ÿå‘½å‘¨æœŸè¾¹ç•Œå¤„æ ¼å¤–å°å¿ƒï¼Œä½ å°±èƒ½æ—¢äº«å—æ€§èƒ½åˆä¿è¯å®‰å…¨ã€‚

