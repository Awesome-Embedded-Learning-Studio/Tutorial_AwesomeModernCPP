# åµŒå…¥å¼C++æ•™ç¨‹â€”â€”å¾ªç¯ç¼“å†²åŒº

åœ¨åµŒå…¥å¼ä¸–ç•Œé‡Œï¼Œæœ‰ä¸€ç±»é—®é¢˜åå¤å‡ºç°ï¼š**æ•°æ®æºä¸åœåœ°äº§ç”Ÿæ•°æ®ï¼Œæ¶ˆè´¹è€…æ…¢æ…¢åœ°å¤„ç†æ•°æ®ï¼Œä¸­é—´è¿˜ä¸æƒ³ mallocã€‚**äºæ˜¯ï¼Œä¸€ä¸ªå¤è€ä½†æ°¸ä¸è¿‡æ—¶çš„æ•°æ®ç»“æ„ç™»åœºäº†â€”â€”**å¾ªç¯ç¼“å†²åŒºï¼ˆCircular Buffer / Ring Bufferï¼‰**ã€‚

ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªä»“åº“ï¼Œåªæœ‰å›ºå®šå¤§å°ï¼Œè£…æ»¡äº†å°±ä»å¤´å†æ¥ã€‚æ²¡æœ‰æ‰©å®¹ã€æ²¡æœ‰ç¢ç‰‡ã€æ²¡æœ‰â€œnew å¤±è´¥â€ï¼Œéå¸¸é€‚åˆ MCUã€é©±åŠ¨ã€ä¸­æ–­ã€DMAã€ä¸²å£ã€éŸ³é¢‘æµç­‰åœºæ™¯ã€‚

------

## ä¸ºä»€ä¹ˆåµŒå…¥å¼è¿™ä¹ˆçˆ±å¾ªç¯ç¼“å†²åŒºï¼Ÿ

åœ¨ PC ä¸–ç•Œï¼Œæˆ‘ä»¬å¯ä»¥éšä¾¿ `new`ã€éšä¾¿ `std::vector::push_back`ã€‚ä½†åœ¨åµŒå…¥å¼é‡Œï¼Œè¿™äº›æ“ä½œå¬èµ·æ¥å°±å¾ˆå±é™©ï¼š

- å †å†…å­˜å°ï¼Œè¿˜å®¹æ˜“ç¢ç‰‡åŒ–
- ä¸­æ–­ä¸Šä¸‹æ–‡é‡Œä¸èƒ½ malloc
- å®æ—¶ç³»ç»Ÿé‡Œä¸å¸Œæœ›å‡ºç°ä¸å¯æ§å»¶è¿Ÿ

è€Œå¾ªç¯ç¼“å†²åŒºçš„ç‰¹æ€§ï¼Œå‡ ä¹æ˜¯ä¸ºåµŒå…¥å¼é‡èº«å®šåšçš„ï¼š

- **å›ºå®šå¤§å°ï¼Œç¼–è¯‘æœŸæˆ–åˆå§‹åŒ–æ—¶ç¡®å®š**
- **O(1) å…¥é˜Ÿ / å‡ºé˜Ÿ**
- **å†…å­˜è¿ç»­ï¼ŒCache å‹å¥½**
- **ä¸éœ€è¦åŠ¨æ€åˆ†é…**
- **å®ç°ç®€å•ï¼Œå®¹æ˜“åšæˆ lock-free / ä¸­æ–­å®‰å…¨**

ä¸€å¥è¯æ€»ç»“ï¼š

> **å®ƒä¸èªæ˜ï¼Œä½†å®ƒå¾ˆå¯é ã€‚**

------

## å¾ªç¯ç¼“å†²åŒºçš„æ ¸å¿ƒæ€æƒ³ï¼ˆå…¶å®éå¸¸æœ´ç´ ï¼‰

å¾ªç¯ç¼“å†²åŒºæœ¬è´¨ä¸Šå°±æ˜¯ï¼š

- ä¸€å—å›ºå®šå¤§å°çš„æ•°ç»„
- ä¸¤ä¸ªç´¢å¼•ï¼š
  - `head`ï¼šå†™å…¥ä½ç½®
  - `tail`ï¼šè¯»å–ä½ç½®

å½“ç´¢å¼•èµ°åˆ°æ•°ç»„æœ«å°¾ï¼Œå°±**ç»•å›å¼€å¤´**ï¼Œåƒä¸€ä¸ªåœ†ã€‚

```text
[ 0 ][ 1 ][ 2 ][ 3 ][ 4 ][ 5 ]
        â†‘         â†‘
      tail      head
```

å†™å…¥æ•°æ®ï¼šç§»åŠ¨ `head`
è¯»å–æ•°æ®ï¼šç§»åŠ¨ `tail`

é‡ç‚¹åªæœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦æƒ³æ¸…æ¥šï¼š
ğŸ‘‰ **å¦‚ä½•åŒºåˆ†â€œæ»¡â€å’Œâ€œç©ºâ€ï¼Ÿ**

------

## å¦‚ä½•åŒºåˆ†â€œç©ºâ€å’Œâ€œæ»¡â€ï¼Ÿï¼ˆç»å…¸éš¾é¢˜ï¼‰

æœ‰ä¸‰ç§å¸¸è§æ–¹æ¡ˆï¼š

1. **æµªè´¹ä¸€ä¸ªå…ƒç´ ï¼ˆæœ€å¸¸è§ï¼‰**
2. é¢å¤–ç»´æŠ¤ä¸€ä¸ª `count`
3. ç”¨ä¸€ä¸ªé¢å¤–çš„ `full` æ ‡å¿—ä½

åœ¨åµŒå…¥å¼é‡Œï¼Œ**æ–¹æ¡ˆ 1 æœ€å—æ¬¢è¿**ï¼šç®€å•ã€æ— æ­§ä¹‰ã€é€»è¾‘æ¸…æ™°ã€‚è§„åˆ™æ˜¯ï¼š

- ç¼“å†²åŒºå¤§å°ä¸º `N`
- å®é™…æœ€å¤šåªèƒ½å­˜ `N - 1` ä¸ªå…ƒç´ 
- æ¡ä»¶åˆ¤æ–­ï¼š
  - ç©ºï¼š`head == tail`
  - æ»¡ï¼š`(head + 1) % N == tail`

æ˜¯çš„ï¼Œæˆ‘ä»¬ç‰ºç‰²äº†ä¸€ä¸ªæ ¼å­ï¼Œæ¢æ¥ä¸€ç”Ÿçš„å®‰å®ã€‚

------

## ä¸€ä¸ªå¹²å‡€çš„ C++ å¾ªç¯ç¼“å†²åŒºå®ç°

ä¸‹é¢æ˜¯ä¸€ä¸ª**æ— åŠ¨æ€å†…å­˜ã€æ¨¡æ¿åŒ–ã€é€‚åˆåµŒå…¥å¼**çš„å®ç°ã€‚

### åŸºæœ¬æ¥å£è®¾è®¡

```cpp
#pragma once
#include <cstddef>
#include <array>

template<typename T, std::size_t Capacity>
class RingBuffer {
public:
    bool push(const T& value);
    bool pop(T& out);

    bool empty() const;
    bool full() const;

    std::size_t size() const;
    std::size_t capacity() const { return Capacity - 1; }

private:
    std::array<T, Capacity> buffer_{};
    std::size_t head_ = 0;
    std::size_t tail_ = 0;
};
```

æ³¨æ„ä¸€ä¸ªç»†èŠ‚ï¼š
ğŸ‘‰ **`Capacity` å®é™…æ•°ç»„å¤§å° = ç”¨æˆ·å¯ç”¨å®¹é‡ + 1**

------

## å…¥é˜Ÿï¼ˆpushï¼‰ï¼šå‘å‰èµ°ä¸€æ­¥

```cpp
template<typename T, std::size_t Capacity>
bool RingBuffer<T, Capacity>::push(const T& value)
{
    if (full()) {
        return false;  // ç¼“å†²åŒºæ»¡äº†
    }

    buffer_[head_] = value;
    head_ = (head_ + 1) % Capacity;
    return true;
}
```

è¿™é‡Œæ²¡æœ‰ä»»ä½•é»‘é­”æ³•ï¼š

- å…ˆåˆ¤æ–­æ˜¯å¦æ»¡
- å†™æ•°æ®
- ç§»åŠ¨ `head`
- å¦‚æœèµ°åˆ°æœ«å°¾ï¼Œç»•å›å¼€å¤´

**O(1)ï¼Œæ°¸è¿œä¸ä¼šæ…¢ã€‚**

------

## å‡ºé˜Ÿï¼ˆpopï¼‰ï¼šæ¶ˆè´¹è€…ç™»åœº

```cpp
template<typename T, std::size_t Capacity>
bool RingBuffer<T, Capacity>::pop(T& out)
{
    if (empty()) {
        return false;  // æ²¡æ•°æ®
    }

    out = buffer_[tail_];
    tail_ = (tail_ + 1) % Capacity;
    return true;
}
```

åŒæ ·ç®€å•ï¼š

- ç©ºå°±å¤±è´¥
- è¯»æ•°æ®
- ç§»åŠ¨ `tail`

------

## çŠ¶æ€åˆ¤æ–­å‡½æ•°

```cpp
template<typename T, std::size_t Capacity>
bool RingBuffer<T, Capacity>::empty() const
{
    return head_ == tail_;
}

template<typename T, std::size_t Capacity>
bool RingBuffer<T, Capacity>::full() const
{
    return (head_ + 1) % Capacity == tail_;
}

template<typename T, std::size_t Capacity>
std::size_t RingBuffer<T, Capacity>::size() const
{
    if (head_ >= tail_) {
        return head_ - tail_;
    }
    return Capacity - (tail_ - head_);
}
```

`size()` è¿™ä¸ªå†™æ³•åœ¨åµŒå…¥å¼é‡Œå¾ˆå¸¸è§ï¼Œ
é¿å…åˆ†æ”¯å¤æ‚åŒ–ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨é¢å¤–è®¡æ•°å™¨ã€‚

------

## ä¸€ä¸ªçœŸå®çš„åµŒå…¥å¼ä½¿ç”¨åœºæ™¯

### ä¸²å£æ¥æ”¶ï¼ˆISR + ä¸»å¾ªç¯ï¼‰

```cpp
RingBuffer<uint8_t, 128> rx_buffer;

void USART_IRQHandler()
{
    uint8_t data = UART_Read();
    rx_buffer.push(data);  // ä¸­æ–­é‡Œåªåšè¿™ä»¶äº‹
}

int main()
{
    while (1) {
        uint8_t ch;
        if (rx_buffer.pop(ch)) {
            process_char(ch);
        }
    }
}
```

è¿™ç§å†™æ³•æœ‰å‡ ä¸ªéå¸¸åµŒå…¥å¼çš„ä¼˜ç‚¹ï¼š

- ISR é‡Œé€»è¾‘æçŸ­
- ä¸ malloc
- ä¸»å¾ªç¯æ…¢æ…¢å¤„ç†
- å³ä½¿å¤„ç†æ…¢ä¸€ç‚¹ï¼Œä¹Ÿä¸ä¼šé˜»å¡ä¸­æ–­

------

## å…³äºçº¿ç¨‹å®‰å…¨ / ä¸­æ–­å®‰å…¨çš„ä¸€ç‚¹ç°å®æé†’

ä¸Šé¢çš„å®ç°æ˜¯ï¼š

- **å•ç”Ÿäº§è€… + å•æ¶ˆè´¹è€…**
- ä¸€ä¸ªåœ¨ä¸­æ–­ï¼Œä¸€ä¸ªåœ¨ä¸»å¾ªç¯

åœ¨å¾ˆå¤š MCU ä¸Šï¼Œè¿™æ˜¯**å¤©ç„¶å®‰å…¨çš„**ï¼ˆåªè¦ç´¢å¼•è¯»å†™æ˜¯åŸå­çš„ï¼‰ã€‚

ä½†å¦‚æœä½ é‡åˆ°ä¸‹é¢æƒ…å†µä¹‹ä¸€ï¼š

- å¤šçº¿ç¨‹
- å¤šä¸ªç”Ÿäº§è€…
- SMP
- RTOS ä»»åŠ¡é—´é€šä¿¡

é‚£ä½ éœ€è¦ï¼š

- å…³ä¸­æ–­
- åŸå­å˜é‡
- æˆ–è€… mutex / spinlock

------

## å’Œ std::queue / std::vector æ¯”ä¸€æ¯”

| æ–¹æ¡ˆ        | æ˜¯å¦åŠ¨æ€åˆ†é… | æ˜¯å¦ç¡®å®šæ€§ | åµŒå…¥å¼å‹å¥½ |
| ----------- | ------------ | ---------- | ---------- |
| std::vector | æ˜¯           | å¦         | âŒ          |
| std::queue  | å–å†³äºåº•å±‚   | å¦         | âŒ          |
| å¾ªç¯ç¼“å†²åŒº  | å¦           | æ˜¯         | âœ…          |





